<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KARAT ‚Äî –¢—Ä–µ–Ω–µ—Ä—ã</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f6f6f6;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    .back-btn {
      position: absolute;
      left: 15px;
      top: 15px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      font-weight: bold;
      color: #333;
    }
    h1 {
      margin-top: 40px;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .hint {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }
    .search {
      max-width: 420px;
      margin: 0 auto 15px auto;
      width: 100%;
      display: flex;
      gap: 10px;
    }
    .search input {
      flex: 1;
      padding: 12px 14px;
      border-radius: 12px;
      border: 2px solid #333;
      font-size: 16px;
      outline: none;
    }
    .menu {
      display: flex;
      flex-direction: column;
      gap: 14px;
      max-width: 420px;
      margin: 0 auto;
    }
    .card {
      background: #fff;
      border-radius: 14px;
      border: 2px solid #333;
      padding: 14px 14px 12px 14px;
      text-align: left;
    }
    .name {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 6px;
    }
    .meta {
      font-size: 15px;
      line-height: 1.35;
      margin-bottom: 10px;
      color: #111;
    }
    .actions {
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }
    .actions a {
      text-decoration: none;
      font-weight: 700;
      color: #1a53ff;
      font-size: 16px;
    }
    .actions a:active { opacity: 0.7; }
    .loading {
      font-size: 18px;
      margin-top: 20px;
    }
    .error {
      font-size: 16px;
      color: #b00020;
      margin-top: 18px;
    }
  </style>
</head>

<body>
  <button class="back-btn" onclick="location.href='admin_menu.html'">‚¨ÖÔ∏è –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</button>

  <h1>–¢—Ä–µ–Ω–µ—Ä—ã</h1>
  <div class="hint">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è: –ø–æ–∑–≤–æ–Ω–∏—Ç—å / –æ—Ç–∫—Ä—ã—Ç—å Telegram</div>

  <div class="search">
    <input id="q" type="text" placeholder="–ü–æ–∏—Å–∫: –§–ò–û / –≥–æ—Ä–æ–¥ / —Ç–µ–ª–µ—Ñ–æ–Ω‚Ä¶" />
  </div>

  <div id="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
  <div id="error" class="error" style="display:none;"></div>
  <div id="list" class="menu" style="display:none;"></div>

<script>
  // ‚úÖ –¢–í–û–ô Apps Script URL
  const API_URL = "https://script.google.com/macros/s/AKfycbydYQAoOMHlIAEZIsSUu3sNALYsltItXaBrc6qYHkUdmRvbfgIAutkhgV1Yowpw46WmFg/exec";

  const loadingEl = document.getElementById("loading");
  const errorEl   = document.getElementById("error");
  const listEl    = document.getElementById("list");
  const qEl       = document.getElementById("q");

  let ALL = [];

  function showError(msg){
    loadingEl.style.display = "none";
    listEl.style.display = "none";
    errorEl.style.display = "block";
    errorEl.textContent = msg;
  }

  function normPhone(phoneValue){
    // –≤ —Ç–∞–±–ª–∏—Ü–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —á–∏—Å–ª–æ–º –∏–ª–∏ —Å—Ç—Ä–æ–∫–æ–π
    let s = String(phoneValue ?? "").replace(/\D/g, "");
    if (!s) return "";
    // –µ—Å–ª–∏ 10 —Ü–∏—Ñ—Ä -> —Å—á–∏—Ç–∞–µ–º –†–§ –±–µ–∑ 7
    if (s.length === 10) s = "7" + s;
    // –µ—Å–ª–∏ 11 –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–µ —Å 7 -> –æ—Å—Ç–∞–≤–∏–º –∫–∞–∫ –µ—Å—Ç—å
    return s;
  }

  function telHref(phoneValue){
    const p = normPhone(phoneValue);
    if (!p) return "";
    return "tel:+" + p;
  }

  function tgHref(tgValue){
    let t = String(tgValue ?? "").trim();
    if (!t) return "";
    // –º–æ–∂–µ—Ç –±—ã—Ç—å "@user" –∏–ª–∏ "https://t.me/user"
    if (t.startsWith("@")) return "https://t.me/" + t.slice(1);
    if (t.startsWith("http://") || t.startsWith("https://")) return t;
    // –µ—Å–ª–∏ –¥–∞–ª–∏ –ø—Ä–æ—Å—Ç–æ "user"
    return "https://t.me/" + t;
  }

  function render(items){
    listEl.innerHTML = "";

    if (!items.length){
      listEl.innerHTML = `<div class="card"><div class="name">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div></div>`;
      return;
    }

    items.forEach(t => {
      const fio   = t["–§–ò–û"] || t["fio"] || t["name"] || t["–§–∏–æ"] || "–ë–µ–∑ –∏–º–µ–Ω–∏";
      const city  = t["–ì–æ—Ä–æ–¥"] || t["city"] || "‚Äî";
      const phone = t["Phone"] ?? t["–¢–µ–ª–µ—Ñ–æ–Ω"] ?? "";
      const tg    = t["–ö–æ–Ω—Ç–∞–∫—Ç_Telegram"] ?? t["Telegram"] ?? t["telegram"] ?? "";

      const tel = telHref(phone);
      const tgLink = tgHref(tg);

      const phonePretty = normPhone(phone)
        ? ("+" + normPhone(phone))
        : "‚Äî";

      const actions = `
        <div class="actions">
          ${tel ? `<a href="${tel}">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>` : `<span style="color:#999;font-weight:700;">üìû –ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞</span>`}
          ${tgLink ? `<a href="${tgLink}" target="_blank" rel="noopener">üí¨ Telegram</a>` : `<span style="color:#999;font-weight:700;">üí¨ –ù–µ—Ç Telegram</span>`}
        </div>
      `;

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="name">${fio}</div>
        <div class="meta">
          –ì–æ—Ä–æ–¥: <b>${city}</b><br>
          –¢–µ–ª–µ—Ñ–æ–Ω: <b>${phonePretty}</b>
        </div>
        ${actions}
      `;

      listEl.appendChild(card);
    });
  }

  function applyFilter(){
    const q = qEl.value.trim().toLowerCase();
    if (!q) { render(ALL); return; }

    const filtered = ALL.filter(t => {
      const fio   = String(t["–§–ò–û"] ?? "").toLowerCase();
      const city  = String(t["–ì–æ—Ä–æ–¥"] ?? "").toLowerCase();
      const phone = String(t["Phone"] ?? "").toLowerCase();
      const tg    = String(t["–ö–æ–Ω—Ç–∞–∫—Ç_Telegram"] ?? "").toLowerCase();
      return fio.includes(q) || city.includes(q) || phone.includes(q) || tg.includes(q);
    });

    render(filtered);
  }

  // ---- START ----
  fetch(API_URL + "?trainers=1")
    .then(r => r.json())
    .then(data => {
      if (!data || data.ok !== true) {
        showError("–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç.");
        console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);
        return;
      }

      ALL = Array.isArray(data.trainers) ? data.trainers : [];
      loadingEl.style.display = "none";
      errorEl.style.display = "none";
      listEl.style.display = "flex";

      render(ALL);
      qEl.addEventListener("input", applyFilter);
    })
    .catch(err => {
      console.error(err);
      showError("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.");
    });
</script>

</body>
</html>
